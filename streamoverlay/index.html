<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Points viewer</title>

    <style>
        body {
            background-color: black;
        }

        #pointsTable {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .teamContainer {
            /*background-color: lime;*/
            width: 10rem;
            text-align: center;
            font-size: 2rem;
            font-family: "Pusab", "Impact", "Bauhaus 93", sans-serif;
            color: white;
        }

        .teamID::before {
            content: "Team: "
        }
    </style>
</head>

<body>
    <div id="pointsTable"></div>

    <script>
        let ws = undefined
        let heartbeat = undefined

        let teams = []

        class Team {
            id = -1
            points = 0

            constructor(id, points) {
                this.id = id
                this.points = points
            }

            isNew() {
                for (let addedTeam of teams) {
                    if (addedTeam.id === this.id)
                        return false
                }
                return true
            }

            addToList() {
                teams.push(this)
            }

            static update() {
                let table = document.getElementById("pointsTable")
                table.innerHTML = "" // clear

                for (let team of teams) {
                    table.innerHTML += '<div class="teamContainer"><div class="teamID">' + team.id + '</div><div class="points">' + team.points + '</div></div>'
                }
            }
        }

        function handleTeam(team) {
            let row = team.split("~|~")

            let teamID = row[0]
            let points = row[1]

            let newTeam = new Team(teamID, points)

            if (newTeam.isNew())
                newTeam.addToList()
            else {
                for (let t of teams) {
                    if (t.id !== teamID)
                        continue

                    t.points = points
                }
            }
            
        }

        function handleData(teams) {
            for (let team of teams) {
                handleTeam(team)
            }

            Team.update()
        }

        function connect() {
            let ws = new WebSocket("ws://localhost:19992")

            ws.onopen = () => {
                if (heartbeat !== undefined)
                    clearInterval(heartbeat)

                heartbeat = setInterval(() => {
                    ws.send("/ping")
                }, 10000)

                ws.send("/settype 1")
            }
            ws.onmessage = e => {
                let msg = String(e.data)
                console.log(msg)

                let command = msg.split(" ")[0]

                if (command !== "/submitpoints")
                    return

                let content = msg.slice(command.length + 1)

                let teams = content.split("~~||~~")

                handleData(teams)
            }

            ws.onclose = () => {
                setTimeout(() => connect(), 1000)
            }
        }

        connect()
    </script>
</body>

</html>